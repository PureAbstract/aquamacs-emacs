#!/bin/sh

# installs files into Emacs.app to make it Aquamacs

# this takes two arguments   

# project-dir (Aquamacs CVS)
# destination .app bundle, e.g. /Applications/Emacs.app

# you can also give -n as first argument if you do not want to compile the .el scripts.


if [ "$1" == "-n" ]; then
    # do NOT compile the scripts
     
    dest=$3
    projdir=$2
else 
    compile=1
    dest=$2
    projdir=$1

fi


if [ ! $dest ]; then

    dest=/Applications/Aquamacs\ Emacs.app

fi

if [ ! $projdir ]; then

    projdir=$HOME/Projects/Aquamacs/aquamacs

fi

oldem="$dest/Contents/MacOS/Emacs"

em="$dest/Contents/MacOS/Aquamacs Emacs"

cd "$dest"
 
rm -r /tmp/backup.site-lisp
mv  "Contents/Resources/site-lisp" /tmp/backup.site-lisp

mkdir Contents/Resources/site-lisp 2>/dev/null
mkdir Contents/Resources/site-lisp/oneonone 2>/dev/null
mkdir Contents/Resources/site-lisp/macosx 2>/dev/null
mkdir Contents/Resources/site-lisp/edit-modes 2>/dev/null

rm -r Contents/Resources/Aquamacs\ Help
cp -pvr $projdir/doc/AquamacsHelp Contents/Resources/Aquamacs\ Help
cp -pvr $projdir/doc/EmacsManual Contents/Resources/Emacs\ Manual
cp -pvr $projdir/src/Emacs.icns Contents/Resources/Emacs.icns

cp -pvr $projdir/src/etc/aquamacs-splash-screen.jpg Contents/Resources/etc/

cp -pvr $projdir/src/Info.plist Contents/
cp -pvr $projdir/src/InfoPlist.strings Contents/Resources/English.lproj/

cp -pvr $projdir/src/emacs-document.icns Contents/Resources/

cp -Rvp $projdir/src/site-lisp/*.el Contents/Resources/site-lisp/

cp -Rvp $projdir/src/site-lisp/edit-modes/* Contents/Resources/site-lisp/edit-modes/
 

cp -Rvp $projdir/src/site-lisp/macosx/*.el Contents/Resources/site-lisp/macosx/
cp -Rvp $projdir/src/site-lisp/oneonone/*.el Contents/Resources/site-lisp/oneonone/

if [ $compile ]; then
    # prevent the site-start.el from being loaded all the time (gives error)
    # doesn't work yet
    # mv Contents/Resources/site-lisp/site-start.el Contents/Resources/site-lisp/site-start.elx
    echo "Compiling site-lisp"
    "$em"  -batch -f batch-byte-compile Contents/Resources/site-lisp/*.el
    echo "Compiling macosx"
    "$em"  -batch -f batch-byte-compile Contents/Resources/site-lisp/macosx/*.el 
    echo "Compiling oneonone"
    "$em"  -batch -f batch-byte-compile Contents/Resources/site-lisp/oneonone/*.el
    #mv Contents/Resources/site-lisp/site-start.elx Contents/Resources/site-lisp/site-start.el
    # echo "(Note: ignore the --no-splash error!)"

# .el is too large
    gzip Contents/Resources/site-lisp/color-theme-themes.el
fi
 
# for LaunchServices (on local machine)
touch .

# replace hardlinks

rm Contents/MacOS/bin/emacs
rm Contents/MacOS/bin/emacs-22.0.50
cd Contents/MacOS/bin/ ; ln -s ../Emacs emacs ; ln -s ../Emacs emacs-22.0.50
