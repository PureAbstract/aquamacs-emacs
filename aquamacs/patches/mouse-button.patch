*** src/macterm.c	Tue Nov 15 23:14:07 2005
--- src/macterm.c	Mon Nov 21 17:39:45 2005
***************
*** 8223,8233 ****
  {
    int result = 0;
    if (!NILP (Vmac_emulate_three_button_mouse)) {
!     int cmdIs3 = !EQ (Vmac_emulate_three_button_mouse, Qreverse);
!     if (modifiers & cmdKey)
!       result = cmdIs3 ? 2 : 1;
!     else if (modifiers & optionKey)
!       result = cmdIs3 ? 1 : 2;
    }
    return result;
  }
--- 8223,8243 ----
  {
    int result = 0;
    if (!NILP (Vmac_emulate_three_button_mouse)) {
!     if (EQ (Vmac_emulate_three_button_mouse, Qreverse))
!       {
! 	result = (modifiers & optionKey) ? ((modifiers & cmdKey) ? 3 : 2) : 
! 	  ((modifiers & cmdKey) ? 1 : 0);
!       }
!     else if (EQ (Vmac_emulate_three_button_mouse, Qcontrol))
!       {
! 	result = (modifiers & controlKey) ? ((modifiers & cmdKey) ? 3 : 2) : 
! 	  ((modifiers & cmdKey) ? 1 : 0);
!       }
!     else 
!       {
! 	result = (modifiers & optionKey) ? ((modifiers & cmdKey) ? 3 : 1) : 
! 	  ((modifiers & cmdKey) ? 2 : 0);
!       }
    }
    return result;
  }
***************
*** 8244,8250 ****
    if (!NILP (Vmac_emulate_three_button_mouse) &&
        GetEventClass(eventRef) == kEventClassMouse)
      {
!       mods &= ~(optionKey | cmdKey);
      }
    return mac_to_emacs_modifiers (mods);
  }
--- 8254,8269 ----
    if (!NILP (Vmac_emulate_three_button_mouse) &&
        GetEventClass(eventRef) == kEventClassMouse)
      {
!       /* Only for a true mouse-1 */
!       EventMouseButton button = kEventMouseButtonPrimary;
!       GetEventParameter (eventRef, kEventParamMouseButton, 
! 			 typeMouseButton, NULL,
! 			 sizeof (EventMouseButton), NULL, &button);
!       if (button == kEventMouseButtonPrimary) 
! 	{
! 	  mods &= ~(((EQ (Vmac_emulate_three_button_mouse, Qcontrol))
! 		     ? controlKey : optionKey) | cmdKey);
! 	}
      }
    return mac_to_emacs_modifiers (mods);
  }
***************
*** 11018,11030 ****
  
    DEFVAR_LISP ("mac-emulate-three-button-mouse",
  	       &Vmac_emulate_three_button_mouse,
!     doc: /* t means that when the option-key is held down while pressing the
! mouse button, the click will register as mouse-2 and while the
! command-key is held down, the click will register as mouse-3.
! 'reverse means that the option-key will register for mouse-3
! and the command-key will register for mouse-2.  nil means that
! no emulation should be done and the modifiers should be placed
! on the mouse-1 event. */);
    Vmac_emulate_three_button_mouse = Qnil;
  
  #if USE_CARBON_EVENTS
--- 11037,11051 ----
  
    DEFVAR_LISP ("mac-emulate-three-button-mouse",
  	       &Vmac_emulate_three_button_mouse,
!     doc: /* Non-nil means emulate mouse buttons using modifier keys.
! t means that when the option-key is held down while pressing the mouse
! button, the click will register as mouse-2 and while the command-key
! is held down, the click will register as mouse-3.  'reverse means that
! the option-key will register for mouse-3 and the command-key will
! register for mouse-2. If `ctrl', a click with the control-key held
! down will register as mouse-3, and command-click will register as
! mouse-2. nil means that no emulation should be done and the modifiers
! should be placed on the mouse-1 event. */);
    Vmac_emulate_three_button_mouse = Qnil;
  
  #if USE_CARBON_EVENTS
