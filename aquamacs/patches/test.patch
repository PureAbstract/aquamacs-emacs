Index: src/macterm.c
===================================================================
RCS file: /cvsroot/emacs/emacs/src/macterm.c,v
retrieving revision 1.204
diff -c -p -r1.204 macterm.c
*** src/macterm.c	13 Feb 2007 08:28:39 -0000	1.204
--- src/macterm.c	19 Feb 2007 01:06:40 -0000
*************** XTread_socket (sd, expected, hold_quit)
*** 11165,11170 ****
--- 11165,11180 ----
  		/* translate the keycode back to determine the
  		   original key */
  #ifdef MAC_OSX
+ 		UCKeyboardLayout *uchr_ptr = NULL;
+ #if MAC_OS_X_VERSION_MAX_ALLOWED >= 1020
+ 		OSStatus err;
+ 		KeyboardLayoutRef layout;
+ 
+ 		err = KLGetCurrentKeyboardLayout (&layout);
+ 		if (err == noErr)
+ 		  KLGetKeyboardLayoutProperty (layout, kKLuchrData,
+ 					       (const void **) &uchr_ptr);
+ #else
  		static SInt16 last_key_layout_id = 0;
  		static Handle uchr_handle = (Handle)-1;
  		SInt16 current_key_layout_id =
*************** XTread_socket (sd, expected, hold_quit)
*** 11176,11183 ****
  		    uchr_handle = GetResource ('uchr', current_key_layout_id);
  		    last_key_layout_id = current_key_layout_id;
  		  }
- 
  		if (uchr_handle)
  		  {
  		    OSStatus status;
  		    UInt16 key_action = er.what - keyDown;
--- 11186,11196 ----
  		    uchr_handle = GetResource ('uchr', current_key_layout_id);
  		    last_key_layout_id = current_key_layout_id;
  		  }
  		if (uchr_handle)
+ 		  uchr_ptr = (UCKeyboardLayout *)*uchr_handle;
+ #endif
+ 
+ 		if (uchr_ptr)
  		  {
  		    OSStatus status;
  		    UInt16 key_action = er.what - keyDown;
*************** XTread_socket (sd, expected, hold_quit)
*** 11188,11194 ****
  		    UniChar code;
  		    UniCharCount actual_length;

! 		    status = UCKeyTranslate ((UCKeyboardLayout *)*uchr_handle,
  					     keycode, key_action,
  					     modifier_key_state,
  					     keyboard_type,
--- 11201,11207 ----
  		    UniChar code;
  		    UniCharCount actual_length;

! 		    status = UCKeyTranslate (uchr_ptr,
  					     keycode, key_action,
  					     modifier_key_state,
  					     keyboard_type,
Index: cus-edit.el
===================================================================
RCS file: /sources/emacs/emacs/lisp/cus-edit.el,v
retrieving revision 1.316
diff -c -r1.316 cus-edit.el
*** lisp/cus-edit.el	21 Jan 2007 03:53:12 -0000	1.316
--- lisp/cus-edit.el	20 Feb 2007 14:42:54 -0000
***************
*** 4192,4202 ****
    (when (and (null custom-file) init-file-had-error)
      (error "Cannot save customizations; init file was not fully loaded"))
    (let* ((filename (custom-file))
! 	 (recentf-exclude (if recentf-mode
! 			      (cons (concat "\\`"
! 					    (regexp-quote (custom-file))
! 					    "\\'")
! 				    recentf-exclude)))
  	 (old-buffer (find-buffer-visiting filename)))
      (with-current-buffer (let ((find-file-visit-truename t))
  			   (or old-buffer (find-file-noselect filename)))
--- 4192,4204 ----
    (when (and (null custom-file) init-file-had-error)
      (error "Cannot save customizations; init file was not fully loaded"))
    (let* ((filename (custom-file))
! 	 (recentf-exclude 
! 	  (if recentf-mode
! 	      (cons (concat "\\`"
! 			    (regexp-quote 
! 			     (recentf-expand-file-name (custom-file)))
! 			    "\\'")
! 		    recentf-exclude)))
  	 (old-buffer (find-buffer-visiting filename)))
      (with-current-buffer (let ((find-file-visit-truename t))
  			   (or old-buffer (find-file-noselect filename)))
Index: python.el
===================================================================
RCS file: /sources/emacs/emacs/lisp/progmodes/python.el,v
retrieving revision 1.53
diff -c -r1.53 python.el
*** lisp/progmodes/python.el	21 Jan 2007 03:20:44 -0000	1.53
--- lisp/progmodes/python.el	19 Feb 2007 15:26:01 -0000
***************
*** 1784,1790 ****
  		 (not (looking-at "[ \t]*$")))
  	    (error "Can't shift all lines enough"))
  	(forward-line))
!       (indent-rigidly start end (- count)))))

  (add-to-list 'debug-ignored-errors "^Can't shift all lines enough")

--- 1784,1791 ----
  		 (not (looking-at "[ \t]*$")))
  	    (error "Can't shift all lines enough"))
  	(forward-line))
!       (indent-rigidly start end (- count))))
!   (setq deactivate-mark nil))

  (add-to-list 'debug-ignored-errors "^Can't shift all lines enough")

***************
*** 1799,1805 ****
    (if count
        (setq count (prefix-numeric-value count))
      (setq count python-indent))
!   (indent-rigidly start end count))

  (defun python-outline-level ()
    "`outline-level' function for Python mode.
--- 1800,1807 ----
    (if count
        (setq count (prefix-numeric-value count))
      (setq count python-indent))
!   (indent-rigidly start end count)
!   (setq deactivate-mark nil))

  (defun python-outline-level ()
    "`outline-level' function for Python mode.
