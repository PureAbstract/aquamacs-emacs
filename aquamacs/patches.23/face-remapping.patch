*** ../emacs.temp/src/nsterm.m	2009-01-02 13:59:45.000000000 +1300
--- src/nsterm.m	2009-01-02 13:59:45.000000000 +1300
***************
*** 1978,1983 ****
--- 1987,1993 ----
    UNBLOCK_INPUT;
  }
  
+ extern struct buffer *current_buffer;
  
  void
  ns_clear_frame_area (struct frame *f, int x, int y, int width, int height)
***************
*** 1987,1997 ****
  {
    NSRect r = NSMakeRect (x, y, width, height);
    NSView *view = FRAME_NS_VIEW (f);
!   struct face *face = FRAME_DEFAULT_FACE (f);
  
    if (!view || !face)
      return;
  
    NSTRACE (ns_clear_frame_area);
  
    r = NSIntersectionRect (r, [view frame]);
--- 1997,2029 ----
  {
    NSRect r = NSMakeRect (x, y, width, height);
    NSView *view = FRAME_NS_VIEW (f);
!   struct face *face =  FRAME_DEFAULT_FACE (f);
!   struct buffer *old_buffer = NULL;
  
    if (!view || !face)
      return;
  
+   //   struct window *w = updated_window;
+   // is the current buffer correct?
+   if (updated_window && current_buffer)
+     {
+       if (XBUFFER (updated_window->buffer) != current_buffer)
+ 	{
+ 	  old_buffer = current_buffer;
+ 	  set_buffer_internal_1 (XBUFFER (updated_window->buffer));
+ 	}
+     
+   
+   int remapped_face = lookup_basic_face (f, DEFAULT_FACE_ID);
+   if (remapped_face)
+     face = FACE_FROM_ID (f, remapped_face);
+ 
+   if (old_buffer)
+     set_buffer_internal_1 (old_buffer);
+   }
+ 
+   //      face = lookup_basic_face (XFRAME (f), DEFAULT_FACE_ID);
+   
    NSTRACE (ns_clear_frame_area);
  
    r = NSIntersectionRect (r, [view frame]);
